<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tableau Timeline</title>
  <style>
    html, body, #tableauViz {
      margin: 0; padding: 0; height: 100%; width: 100%;
    }
  </style>
</head>
<body>
  <div id="tableauViz"></div>

  <script type="module">
    import * as tableau from 'https://public.tableau.com/javascripts/api/tableau.embedding.3.latest.min.js';

    const vizContainer = document.getElementById('tableauViz');
    const vizUrl = "https://public.tableau.com/views/timelineTrifecta/Dashboard16";
    let viz;
    let isInteractive = false;

    async function createTableauViz() {
      try {
        viz = await tableau.createViz(vizContainer, vizUrl, {
          hideTabs: true,
          width: '100%',
          height: '100%',
          onFirstInteractive: () => {
            isInteractive = true;
            console.log("Tableau viz is interactive");
          },
          onError: (error) => {
            console.error('Tableau viz error:', error);
          }
        });
      } catch (error) {
        console.error("Error creating Tableau viz:", error);
      }
    }

    async function applyFilter(siteID) {
      if (!isInteractive) {
        console.warn("Viz not interactive yet, cannot apply filter");
        return;
      }
      try {
        const workbook = viz.getWorkbook();
        const activeSheet = workbook.getActiveSheet();

        let targetSheet;
        if (activeSheet.getSheetType() === 'dashboard') {
          const worksheets = activeSheet.getWorksheets();
          targetSheet = worksheets.find(sheet => sheet.getName() === 'timeline');
        } else {
          targetSheet = activeSheet;
        }

        if (targetSheet) {
          await targetSheet.applyFilterAsync('siteID', siteID, tableau.FilterUpdateType.REPLACE);
          console.log(`Filter applied: siteID = ${siteID}`);
        } else {
          console.warn("Worksheet 'timeline' not found.");
        }
      } catch (err) {
        console.error('Error applying filter:', err);
      }
    }

    // Listen for messages from Wix page
    window.addEventListener('message', (event) => {
      // Optionally verify event.origin here
      const siteID = event.data;
      if (siteID) {
        if (isInteractive) {
          applyFilter(siteID);
        } else {
          // Wait for the viz to be interactive before applying filter
          const interval = setInterval(() => {
            if (isInteractive) {
              clearInterval(interval);
              applyFilter(siteID);
            }
          }, 300);
        }
      }
    });

    // Initialize viz on load
    createTableauViz();
  </script>
</body>
</html>
