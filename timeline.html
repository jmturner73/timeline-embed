<script type="module" src="https://public.tableau.com/javascripts/api/tableau.embedding.3.latest.min.js"></script>

<tableau-viz
  id="tableauViz"
  src="https://public.tableau.com/views/timelineTrifecta/Dashboard16"
  toolbar="bottom"
  hide-tabs>
</tableau-viz>

<script>
  // Notify parent (Wix) that iframe is ready
  window.onload = () => {
    console.log('üëã Iframe ready, sending handshake to parent...');
    window.parent.postMessage('ready', 'https://www.the-big-green-machine.com');
  };

  // Listen for filter message from Wix
  window.addEventListener('message', async (event) => {
    const allowedOrigin = 'https://www.the-big-green-machine.com';
    if (event.origin !== allowedOrigin) return;

    const { siteId } = event.data;
    const tableauViz = document.getElementById('tableauViz');

    try {
      await tableauViz.ready;
      const workbook = tableauViz.workbook;
      const activeSheet = workbook.activeSheet;

      let targetSheet = activeSheet;
      if (activeSheet.sheetType === 'dashboard') {
        const sheets = activeSheet.worksheets;
        targetSheet = sheets.find(sheet => sheet.name === 'timeline'); // Update if needed
      }

      if (targetSheet) {
        await targetSheet.applyFilterAsync('Site ID', siteId, 'replace');
        console.log('‚úÖ Filter applied for Site ID:', siteId);
      }
    } catch (err) {
      console.error('‚ùå Failed to apply filter:', err);
    }
  });
</script>
