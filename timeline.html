<script>
  // Notify Wix that iframe is ready
  window.onload = () => {
    window.parent.postMessage('ready', 'https://www.the-big-green-machine.com');
  };

  // Listen for siteId from Wix
  window.addEventListener('message', async (event) => {
    const allowedOrigin = 'https://www.the-big-green-machine.com';
    if (event.origin !== allowedOrigin) return;

    const { siteId } = event.data;
    const tableauViz = document.getElementById('tableauViz');

    try {
      await tableauViz.ready;

      // ✅ Get the Viz API instance
      const viz = await tableauViz.viz;

      // ✅ Now workbook is accessible
      const workbook = viz.workbook;
      const activeSheet = workbook.activeSheet;

      let targetSheet = activeSheet;
      if (activeSheet.sheetType === 'dashboard') {
        const sheets = activeSheet.worksheets;
        targetSheet = sheets.find(sheet => sheet.name === 'timeline'); // Update if your worksheet name is different
      }

      if (targetSheet) {
        await targetSheet.applyFilterAsync('Site ID', siteId, 'replace');
        console.log('✅ Filter applied for Site ID:', siteId);
      } else {
        console.warn('⚠️ Target sheet not found');
      }

    } catch (err) {
      console.error('❌ Failed to apply filter:', err);
    }
  });
</script>
